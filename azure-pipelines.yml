# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger: none

jobs:
  - job: Aarch64_Manylinux2014Build
    pool:
      vmImage: 'ubuntu-18.04'
    strategy:
      matrix:
        Py36 Arm64:
          python.version: '3.6'
        Py37 Arm64:
          python.version: '3.7'
        Py38 Arm64:
          python.version: '3.8'
        Py39 Arm64:
          python.version: '3.9'
    steps:
    - script: docker run --rm --privileged hypriot/qemu-register
      displayName: 'Registering qemu'
    - script: |
        set -xeo pipefail
        docker run -v $(pwd):"${DOCKER_ROOT_DIRECTORY}":rw,z \
                   -e HOST_USER_ID \
                    "arm64v8/ubuntu:bionic" \
                    bash -c "cd $DOCKER_ROOT_DIRECTORY;
                    apt-get update -qq && apt-get install -qq make $PYTHON python3-pip lib$PYTHON-dev git build-essential libssl-dev libffi-dev cargo snapd && \
                    $PYTHON -m pip install --upgrade pip && \
                    $PYTHON -m pip install setuptools setuptools-rust wheel pytest-azurepipelines twine numpy && \
                    $PYTHON setup.py bdist_wheel"
      displayName: 'Running AArch64 build'
      env:
        DOCKER_ROOT_DIRECTORY: "/home/source_root"
        HOST_USER_ID: $(id -u)
        PYTHON: "python$(python.version)"
